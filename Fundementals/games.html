<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fun Time With Joe</title>

    <link rel="icon" type="image/x-icon" href="https://cdn.jgkd.dev/Favicon">

    <style></style>
</head>

<body>
    <header id="header">
        <h1 id="title">Joe's Fun Collection Of Games</h1>
        <h2 id="subtitle"></h2>
        <h3 id="recent_games_title"></h3>
    </header>
    <div class="games" id="recent"></div>
    <h3 id="games_message"></h3>
    <div class="games" id="container"></div>
    <footer id="button-container"></footer>
</body>
<script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const type = urlParams.get("type");

    const title = document.getElementById("title");
    const sub_title = document.getElementById("subtitle");
    const recent_games = document.getElementById("recent")
    const games_container = document.getElementById("container");
    const button_container = document.getElementById("button-container");
    const recent_games_title = document.getElementById("recent_games_title");
    const games_message = document.getElementById("games_message");

    // cookie functions
    function setCookie(cname, cvalue) {
        document.cookie = cname + "=" + cvalue + ";"
    }


    function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i]
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    function checkCookie() {
        let checkUser = getCookie("username");
        if (checkUser != "") {
            user = checkUser
            return user
        } else {
            user = prompt("Please enter your name to access: ")
            if (user != "" && user != null) {
                setCookie("username", user)
                return user
            }
        }
    }

    function getPastGames() {
        const decodedCookie = decodeURIComponent(document.cookie);
        const cookieArray = decodedCookie.split(";");

        const resultArray = [];
        const cookieNamePrefix = "lastGame";

        for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i].trim();
            const [key, value] = cookie.split("=");

            if (key.startsWith(cookieNamePrefix)) {
                resultArray.push({ key: key, value: value });
            }
        }

        return resultArray;
    };

    if (type == "iframe") {
        var ss = document.createElement("link");

        ss.rel = "stylesheet";
        ss.type = "text/css";
        ss.href = "./src/css/iframegames.css"

        document.head.appendChild(ss);

        recentGames = getCookie("lastGame1")

        if (recentGames != false) { // <div class="games" id="recent"></div>
            recent_games_title.innerHTML = "How about your most recent game: "
            games_message.innerHTML = "Or check out our other games:"
        };
    } else {
        var ss = document.createElement("link");

        ss.rel = "stylesheet";
        ss.type = "text/css";
        ss.href = "./src/css/games.css"

        document.head.appendChild(ss);

        username = checkCookie()
        sub_title.innerHTML = `Hey, ${username}! What would you like to play?`

        recentGames = getPastGames()

        if (recentGames != false) { 
            recent_games_title.innerHTML = "How about one of your recent games:"
            games_message.innerHTML = "Or check out our other games:"
        };

        var gb = document.createElement("a");
        gb.setAttribute("href", "./index.html");
        button_container.appendChild(gb)

        var gb_btn = document.createElement("button");
        gb_btn.innerHTML = "GO HOME";
        gb.appendChild(gb_btn)
    };

    // generate games

    const data_url = "https://api.jgkd.dev/btc/fundementals/games.json";

    fetch(data_url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to fetech JSON. Status code: ${response.status}`);
            }
            return response.json();
        })
        .then(jsonData => {
            var game_data = jsonData

            console.log(game_data)

            if (recentGames != false) {
                function recent_create(current_name) {
                    var recent_card = document.createElement("div");
                    recent_card.setAttribute("class", "game");
                    recent_games.appendChild(recent_card);

                    var recent_a = document.createElement("a");
                    recent_card.appendChild(recent_a);

                    var recent_text = document.createElement("h2");
                    recent_text.innerHTML = game_data[current_name]["display_name"];
                    recent_a.appendChild(recent_text);

                    var recent_img = document.createElement("img");
                    recent_img.setAttribute("src", game_data[current_name]["img"])
                    recent_a.appendChild(recent_img);

                    if (type != "iframe") {
                        recent_a.setAttribute("target", "_blank");
                        recent_a.setAttribute("href", game_data[current_name]["location"]);
                        recent_a.setAttribute("href", `${game_data[current_name]["location"]}&from=iframe`);
                    }
                }
 
                if (type == "iframe") {
                    current_name = recentGames;

                    recent_create(current_name);
                } else {
                    for (var i in recentGames) {
                        current_name = recentGames[i].value;

                        recent_create(current_name);
                    };
                }       
            }

            for (var i in game_data) {
                current_game = game_data[i];

                var card = document.createElement("div");
                card.setAttribute("class", "game");
                games_container.appendChild(card);

                var a = document.createElement("a");

                if (type != "iframe") {
                console.log("Not iframe")
                a.setAttribute("target", "_blank");
                a.setAttribute("href", current_game["location"]);
                
                } else {
                    a.setAttribute("href", `${current_game["location"]}&from=iframe`);
                };

                card.appendChild(a);

                var text = document.createElement("h2");
                text.innerHTML = current_game["display_name"];
                a.appendChild(text);

                var img = document.createElement("img");
                img.setAttribute("src", current_game["img"])
                a.appendChild(img);
            };

        })
        .catch(error => {
            console.error(`Error: ${error.message}`)
        })
</script>

</html>